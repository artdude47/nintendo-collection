@page "/items"
<PageTitle>Nintendo Collection</PageTitle>
@using Collection.Domain
@using Collection.Web.Services
@using Microsoft.AspNetCore.Components.Authorization

@inject InventoryService Inventory
@inject CsvImportService CsvService
@inject IJSRuntime JS
@inject NavigationManager Nav

<h1 class="mb-2 page-title no-select">Nintendo Collection</h1>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    @foreach (var t in toasts)
    {
        <div class="toast show align-items-center border-0 mb-2 @($"text-bg-{t.variant}")"
             role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">@t.message</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="() => DismissToast(t)"></button>
            </div>
        </div>
    }
</div>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div class="d-flex align-items-center gap-2">
        <AuthorizeView>
            <Authorized>
                <button class="btn btn-success btn-sm" title="Add a new item" @onclick="OpenNewModal">
                    <span class="oi oi-plus me-1"></span>Add Item
                </button>
            </Authorized>
        </AuthorizeView>

        <a class="btn btn-outline-secondary btn-sm" title="Download CSV" href="/api/export.csv">
            <span class="oi oi-data-transfer-download me-1"></span>Export CSV
        </a>

        <label for="pageSizeSel" class="form-label mb-0 small text-muted">Results:</label>
        <select id="pageSizeSel" class="form-select form-select-sm w-auto" @onchange="OnPageSizeChange" value="@_pageSize">
            @foreach (var s in pageSizeOptions)
            {
                <option value="@s">@s</option>
            }
        </select>
    </div>

    <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width:240px;max-width:520px;">
        <label for="searchBox" class="form-label mb-0 small text-muted me-1">Search:</label>
        <input id="searchBox"
               class="form-control form-control-sm header-search"
               placeholder="Search Title..."
               value="@search"
               @oninput="OnSearchInput" />
        <button class="btn btn-outline-secondary btn-sm"
                title="Clear Search"
                @onclick="ClearSearch"
                disabled="@(string.IsNullOrWhiteSpace(search))">
            x
        </button>
    </div>

    <div class="d-flex align-items-center gap-2">
        <select class="form-select form-select-sm w-auto" @onchange="OnKindChange" value="@selectedKind">
            <option value="">(Kind)</option>
            @foreach (var k in Enum.GetNames(typeof(ItemKind)))
            {
                <option value="@k">@k</option>
            }
        </select>

        <select class="form-select form-select-sm w-auto" @onchange="OnRegionChange" value="@selectedRegion">
            <option value="">(Region)</option>
            @foreach (var r in regionOptions)
            {
                <option value="@r">@r</option>
            }
        </select>
    </div>

    <AuthorizeView>
        <Authorized>
            <form method="post" action="/logout" class="d-inline">
                <button type="submit" class="btn btn-outline-secondary btn-sm">Sign out</button>
            </form>
        </Authorized>
        <NotAuthorized>
            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="OpenLoginModal">Sign In</button>
        </NotAuthorized>
    </AuthorizeView>
</div>

@if (!string.IsNullOrWhiteSpace(selectedPlatform) || !string.IsNullOrWhiteSpace(selectedCib) || !string.IsNullOrWhiteSpace(search))
{
    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <span class="small text-muted me-1">Filters:</span>
        @if (!string.IsNullOrWhiteSpace(selectedPlatform))
        {
            <span class="badge rounded-pill text-bg-secondary">
                Platform: @selectedPlatform
                <button type="button" class="btn-close btn-close-white btn-close-sm ms-1" @onclick="@(() => { selectedPlatform = null; _ = DebouncedLoad(0); })"></button>
            </span>
        }
        <button class="btn btn-link btn-sm text-decoration-none" @onclick="@(() => { selectedPlatform = null; search = ""; _page = 1; _ = DebouncedLoad(0); })">Clear all</button>
    </div>
}

<AuthorizeView>
    <Authorized>
        <details class="mb-3">
            <summary class="fw-semibold">Data (CSV Import)</summary>
            <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
                <InputFile OnChange="UploadCsvDryRun" />
                <button class="btn btn-outline-primary btn-sm" @onclick="ConfirmImport" disabled="@(!canCommitImport)">
                    Commit Upload
                </button>
                <span class="text-muted small">@importStatus</span>
            </div>
        </details>
    </Authorized>
</AuthorizeView>

@if (isLoading)
{
    <div class="small text-muted">Loading...</div>
}
else if (pageResult.items.Count == 0)
{
    <div class="text-muted">No Items Found.</div>
}
else
{
    <table class="table table-striped table-sm table-collection">
        <thead>
            <tr>
                <th role="button" @onclick='() => SetSort("title")'>Title @SortGlyph("title")</th>
                <th role="button" @onclick='() => SetSort("platform")'>Platform @SortGlyph("platform")</th>
                <th role="button" @onclick='() => SetSort("cib")'>CIB @SortGlyph("cib")</th>
                <th role="button" @onclick='() => SetSort("condition")'>Cond @SortGlyph("condition")</th>
                <th role="button" @onclick='() => SetSort("purchase")'>Price @SortGlyph("purchase")</th>
                <th role="button" @onclick='() => SetSort("value")'>Value @SortGlyph("value")</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var i in pageResult.items)
            {
                <tr style="cursor:pointer" @onclick="() => OpenDetails(i)">
                    <td>@i.Title</td>
                    <td>@i.Platform?.Name</td>
                    <td>@(i.IsCib ? "Yes" : "No")</td>
                    <td>@i.Condition</td>
                    <td>@i.PurchasePrice?.ToString("C")</td>
                    <td>@i.EstimatedValue?.ToString("C")</td>
                    <td @onclick:stopPropagation="true">
                        <AuthorizeView>
                            <Authorized>
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEdit(i)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(i.Id)">Delete</button>
                            </Authorized>
                        </AuthorizeView>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex align-items-center">
        <button class="btn btn-sm btn-outline-secondary" @onclick="Prev" disabled="@(_page <= 1)">Prev</button>
        <span class="mx-3">Page @_page of @totalPages (@pageResult.total items)</span>
        <button class="btn btn-sm btn-outline-secondary" @onclick="Next" disabled="@(_page >= totalPages)">Next</button>
    </div>
}

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@(editing?.Id == 0 ? "New Item" : "Edit Item")</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" @onclick="CancelEdit"></button>
            </div>
            <div class="modal-body">
                @if (editing is not null)
                {
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Title *</label>
                            <input class="form-control" @bind="editing.Title" maxlength="200" placeholder="Title..." />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Platform *</label>
                            <select class="form-select" @bind="editing.PlatformId">
                                @foreach (var p in platforms)
                                {
                                    <option value="@p.Id">@p.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Kind</label>
                            <select class="form-select" @bind="editing.Kind">
                                @foreach (var k in Enum.GetValues<ItemKind>())
                                {
                                    <option value="@k">@k</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Condition</label>
                            <select class="form-select" @bind="editing.Condition">
                                @foreach (var c in Enum.GetValues<Condition>())
                                {
                                    <option value="@c">@c</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Region</label>
                            <select class="form-select" @bind="editing.Region">
                                @foreach (var r in regionOptions)
                                {
                                    <option value="@r">@r</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end gap-3">
                            <div class="form-check">
                                <input id="chkBox" type="checkbox" class="form-check-input" @bind="editing.HasBox" />
                                <label for="chkBox" class="form-check-label">Box</label>
                            </div>
                            <div class="form-check">
                                <input id="chkMan" type="checkbox" class="form-check-input" @bind="editing.HasManual" />
                                <label for="chkMan" class="form-check-label">Manual</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Purchase Price</label>
                            <input class="form-control" type="number" step="0.01" @bind="editing.PurchasePrice" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Est. Value</label>
                            <input class="form-control" type="number" step="0.01" @bind="editing.EstimatedValue" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Purchase Date</label>
                            <input class="form-control" type="date" @bind="editing.PurchaseDate" />
                        </div>
                         <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" rows="3" @bind="editing.Notes"></textarea>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveEdit">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @if (details is not null)
                {
                    <h4>@details.Title</h4>
                    <p class="text-muted">@details.Platform?.Name - @details.Region</p>
                    <hr />
                    <dl class="row">
                        <dt class="col-4">Condition</dt><dd class="col-8">@details.Condition</dd>
                        <dt class="col-4">Value</dt><dd class="col-8">@details.EstimatedValue?.ToString("C")</dd>
                        <dt class="col-4">Purchased</dt><dd class="col-8">@details.PurchaseDate?.ToString("d") for @details.PurchasePrice?.ToString("C")</dd>
                        <dt class="col-4">Notes</dt><dd class="col-8">@details.Notes</dd>
                    </dl>
                }
            </div>
        </div>
    </div>
</div>

@code {
    // --- STATE ---
    Item? editing; 
    Item? details;
    
    // Use the Wrapper from ApiClient or InventoryService (make sure they match)
    ApiClient.Page<Item> pageResult = new() { items = new(), total = 0 };
    List<Platform> platforms = new();
    CancellationTokenSource? _searchCts;

    // Filters
    string? selectedPlatform;
    string? selectedCib;
    string? search;
    string? selectedKind;
    string? selectedRegion;
    string sort = "title_asc";
    int _page = 1;
    int _pageSize = 50;
    
    int totalPages => Math.Max(1, (int)Math.Ceiling((double)pageResult.total / _pageSize));
    bool isLoading;

    // Helpers
    readonly string[] regionOptions = new[] { "NTSC-U", "NTSC-J", "PAL", "Other" };
    readonly int[] pageSizeOptions = new[] { 25, 50, 100, 200 };

    // --- LIFECYCLE ---
    protected override async Task OnInitializedAsync()
    {
        // Load platforms directly from DB service
        platforms = await Inventory.GetPlatformsAsync();
        
        // Load URL query params
        ApplyQueryOnce();
        
        await Load();
    }

    async Task Load()
    {
        isLoading = true;
        StateHasChanged();
        try
        {
            bool? isCib = string.IsNullOrEmpty(selectedCib) ? null : selectedCib == "true";
            
            // CALL INVENTORY SERVICE
            pageResult = await Inventory.GetItemsAsync(
                selectedPlatform, isCib, search, sort, selectedKind, selectedRegion, null, _page, _pageSize
            );
            
            UpdateQueryUrl();
        }
        catch (Exception ex) { ToastError("Load failed: " + ex.Message); }
        finally 
        { 
            isLoading = false; 
            StateHasChanged(); 
        }
    }

    // --- ACTIONS ---
    async Task StartEdit(Item source)
    {
        // Deep copy manually to prevent live-editing the table row
        editing = new Item 
        { 
            Id = source.Id, 
            Title = source.Title,
            PlatformId = source.PlatformId, 
            Platform = source.Platform,
            Region = source.Region,
            Condition = source.Condition,
            Kind = source.Kind,
            HasBox = source.HasBox,
            HasManual = source.HasManual,
            PurchasePrice = source.PurchasePrice,
            PurchaseDate = source.PurchaseDate,
            EstimatedValue = source.EstimatedValue,
            Notes = source.Notes,
        };
        
        await JS.InvokeVoidAsync("modal.show", "editModal");
    }

    void OpenNewModal()
    {
        // Initialize with Defaults
        editing = new Item 
        { 
            Id = 0, 
            Condition = Condition.Good, 
            Region = "NTSC-U", 
            PlatformId = platforms.FirstOrDefault()?.Id ?? 0 
        };
        JS.InvokeVoidAsync("modal.show", "editModal");
    }

    async Task SaveEdit()
    {
        if (editing is null) return;
        if (string.IsNullOrWhiteSpace(editing.Title)) { ToastError("Title required"); return; }
        if (editing.PlatformId == 0) { ToastError("Platform required"); return; }

        // Call Service
        await Inventory.SaveItemAsync(editing);
        
        await JS.InvokeVoidAsync("modal.hide", "editModal");
        editing = null;
        ToastOk("Saved!");
        await Load();
    }

    async Task ConfirmDelete(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Delete this item?"))
        {
            await Inventory.DeleteItemAsync(id);
            await Load();
            ToastOk("Deleted.");
        }
    }

    void CancelEdit() 
    {
        editing = null;
        JS.InvokeVoidAsync("modal.hide", "editModal");
    }
    
    void OpenDetails(Item item)
    {
        details = item;
        JS.InvokeVoidAsync("modal.show", "detailsModal");
    }

    // --- FILTERS & CSV ---
    byte[]? lastUpload; string? lastUploadName; bool canCommitImport; string importStatus = "";

    async Task UploadCsvDryRun(InputFileChangeEventArgs e)
    {
        importStatus = "Validating...";
        using var stream = e.File.OpenReadStream(512000);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        ms.Position = 0;
        
        var report = await CsvService.ProcessAsync(ms, dryRun: true);
        
        if (report.Rows.All(r => r.IsValid)) {
            canCommitImport = true;
            importStatus = $"Dry run OK. {report.Rows.Count} rows.";
            lastUpload = ms.ToArray();
            lastUploadName = e.File.Name;
        } else {
            importStatus = "Errors found.";
        }
    }

    async Task ConfirmImport()
    {
        if (lastUpload is null) return;
        using var ms = new MemoryStream(lastUpload);
        await CsvService.ProcessAsync(ms, dryRun: false);
        canCommitImport = false;
        importStatus = "Imported!";
        await Load();
    }
    
    // --- UI HELPERS ---
    void OnSearchInput(ChangeEventArgs e) { search = e.Value?.ToString(); _ = DebouncedLoad(); }
    void ClearSearch() { search = ""; _ = DebouncedLoad(0); }
    void OnPageSizeChange(ChangeEventArgs e) { 
        if(int.TryParse(e.Value?.ToString(), out var s)) { _pageSize = s; _page=1; _=DebouncedLoad(0); } 
    }
    void OnKindChange(ChangeEventArgs e) { selectedKind = e.Value?.ToString(); _page=1; _=DebouncedLoad(); }
    void OnRegionChange(ChangeEventArgs e) { selectedRegion = e.Value?.ToString(); _page=1; _=DebouncedLoad(); }
    
    async Task DebouncedLoad(int delayMs = 300) {
        _searchCts?.Cancel(); _searchCts = new();
        try { await Task.Delay(delayMs, _searchCts.Token); await Load(); } catch {}
    }
    
    void Next() { if (_page < totalPages) { _page++; _ = Load(); }}
    void Prev() { if (_page > 1) { _page--; _ = Load(); }}
    
    RenderFragment SortGlyph(string key) => builder => {  };
    void SetSort(string key) {  _ = Load(); }

    // Query String Logic
    bool _queryApplied;
    void ApplyQueryOnce() {  } 
    void UpdateQueryUrl() {  }

    // Toast Logic
    record Toast(string message, string variant);
    List<Toast> toasts = new();
    void ToastOk(string m) => toasts.Add(new Toast(m, "success"));
    void ToastError(string m) => toasts.Add(new Toast(m, "danger"));
    void DismissToast(Toast t) { toasts.Remove(t); }
    
    // Login Logic
    async Task OpenLoginModal() => await JS.InvokeVoidAsync("modal.show", "loginModal");
}